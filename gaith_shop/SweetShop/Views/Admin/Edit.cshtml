@model Product
@{
    ViewData["Title"] = "تعديل المنتج";
    Layout = "_AdminLayout";
}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="admin-card">
            <div class="admin-card-header">
                <h5><i class="bi bi-pencil-square me-2" style="color:#d97706;"></i>تعديل: @Model.Name</h5>
                <a asp-action="Index" style="color:#94a3b8;font-size:13px;text-decoration:none;">
                    <i class="bi bi-arrow-right me-1"></i>العودة للقائمة
                </a>
            </div>
            <div class="admin-card-body">
                <form asp-action="Edit" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="Id" />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="admin-form-group">
                                <label asp-for="Name">اسم المنتج <span style="color:#ef4444;">*</span></label>
                                <input asp-for="Name" class="admin-form-control" placeholder="أدخل اسم المنتج" />
                                <span asp-validation-for="Name" class="text-danger" style="font-size:12px;"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="admin-form-group">
                                <label asp-for="Price">السعر (د.أ) <span style="color:#ef4444;">*</span></label>
                                <input asp-for="Price" class="admin-form-control" placeholder="0.00" type="number"
                                    step="0.01" />
                                <span asp-validation-for="Price" class="text-danger" style="font-size:12px;"></span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="admin-form-group">
                                <label asp-for="Description">الوصف</label>
                                <textarea asp-for="Description" class="admin-form-control" rows="3"
                                    placeholder="وصف المنتج..."></textarea>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="admin-form-group">
                                <label>تغيير صورة المنتج</label>
                                <input type="file" name="imageFile" class="admin-form-control" accept="image/*" />
                                <span class="text-muted" style="font-size:12px;">اترك الحقل فارغاً إذا كنت ترغب
                                    بالاحتفاظ بالصورة الحالية</span>
                                <!-- نحتفظ بالرابط القديم في حال لم يرفع صورة جديدة -->
                                <input type="hidden" asp-for="ImageUrl" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="admin-form-group">
                                <label asp-for="CategoryId">التصنيف <span style="color:#ef4444;">*</span></label>
                                <select asp-for="CategoryId" class="admin-form-control admin-form-select"
                                    asp-items="ViewBag.CategoryId">
                                    <option value="">-- اختر تصنيفاً --</option>
                                </select>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(Model.ImageUrl))
                        {
                            <div class="col-12">
                                <div style="background:#f8fafc;padding:14px;border-radius:10px;border:1px solid #e2e8f0;">
                                    <div style="font-size:12px;color:#94a3b8;margin-bottom:8px;">معاينة الصورة الحالية:
                                    </div>
                                    <img src="@Model.ImageUrl" alt="@Model.Name"
                                        style="height:80px;border-radius:8px;object-fit:cover;">
                                </div>
                            </div>
                        }

                        <div class="col-md-6">
                            <div
                                style="display:flex;align-items:center;gap:10px;padding:14px;background:#f8fafc;border-radius:10px;border:1px solid #e2e8f0;">
                                <input asp-for="InStock" type="checkbox"
                                    style="width:18px;height:18px;accent-color:#1A8CB0;">
                                <div>
                                    <label asp-for="InStock"
                                        style="margin:0;font-weight:500;color:#334155;cursor:pointer;">متوفر في
                                        المخزون</label>
                                    <div style="font-size:12px;color:#94a3b8;">يظهر في الموقع للمشترين</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div
                                style="display:flex;align-items:center;gap:10px;padding:14px;background:#fefce8;border-radius:10px;border:1px solid #fde68a;">
                                <input asp-for="IsPreferredSweet" type="checkbox"
                                    style="width:18px;height:18px;accent-color:#C7AE6A;">
                                <div>
                                    <label asp-for="IsPreferredSweet"
                                        style="margin:0;font-weight:500;color:#334155;cursor:pointer;">
                                        <i class="bi bi-star-fill me-1" style="color:#C7AE6A;"></i>حلوى مفضلة
                                    </label>
                                    <div style="font-size:12px;color:#94a3b8;">يظهر في قسم الحلويات المميزة</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 mt-4">
                            <div style="background:#f8fafc;padding:20px;border-radius:10px;border:1px solid #e2e8f0;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 style="color:#334155;margin:0;"><i class="bi bi-box-seam me-2"
                                            style="color:#1A8CB0;"></i>أوزان وأحجام المنتج</h6>
                                    <button type="button" id="addVariantBtn" class="btn btn-sm btn-outline-primary"
                                        style="border-radius:6px;font-size:13px;">
                                        <i class="bi bi-plus"></i> إضافة وزن/حجم
                                    </button>
                                </div>

                                <div id="variantsContainer">
                                    @if (Model.Configurations != null && Model.Configurations.Any())
                                    {
                                        int i = 0;
                                        foreach (var variant in Model.Configurations)
                                        {
                                            <div class="row g-2 mb-3 variant-row align-items-end"
                                                style="background:#fff;padding:15px;border-radius:8px;border:1px solid #e2e8f0;">
                                                <input type="hidden" name="Configurations[@i].Id" value="@variant.Id" />
                                                <input type="hidden" name="Configurations[@i].ProductId"
                                                    value="@variant.ProductId" />

                                                <div class="col-md-5">
                                                    <label class="form-label" style="font-size:13px;color:#64748b;">الوزن /
                                                        الحجم</label>
                                                    <input type="text" name="Configurations[@i].Weight" value="@variant.Weight"
                                                        class="admin-form-control" required />
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label" style="font-size:13px;color:#64748b;">السعر
                                                        (د.أ)</label>
                                                    <input type="number" step="0.01" name="Configurations[@i].Price"
                                                        value="@variant.Price" class="admin-form-control" required />
                                                </div>
                                                <div class="col-md-2 text-center pb-2">
                                                    <div class="form-check form-switch d-inline-block">
                                                        <input class="form-check-input" type="checkbox"
                                                            name="Configurations[@i].IsDefault" value="true" id="default_@i"
                                                        @(variant.IsDefault ? "checked" : "")>
                                                        <label class="form-check-label" style="font-size:12px;"
                                                            for="default_@i">افتراضي</label>
                                                    </div>
                                                    <input type="hidden" name="Configurations[@i].IsDefault" value="false" />
                                                </div>
                                                <div class="col-md-1 text-end pb-1">
                                                    <button type="button"
                                                        class="btn btn-sm btn-outline-danger remove-variant-btn"
                                                        style="border:none;">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            i++;
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr style="margin:24px 0;border-color:#f1f5f9;">

                    <div style="display:flex;gap:12px;justify-content:flex-end;">
                        <a asp-action="Index"
                            style="padding:10px 20px;border-radius:9px;background:#f1f5f9;color:#64748b;text-decoration:none;font-size:14px;">
                            إلغاء
                        </a>
                        <button type="submit" class="btn-admin-primary">
                            <i class="bi bi-check-lg"></i> حفظ التعديلات
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

        <script>
            $(document).ready(function () {
                let variantIndex = @(Model.Configurations != null ? Model.Configurations.Count() : 0);

                $('#addVariantBtn').click(function () {
                    const html = `
                        <div class="row g-2 mb-3 variant-row align-items-end" style="background:#fff;padding:15px;border-radius:8px;border:1px solid #e2e8f0;position:relative;">
                            <!-- new variant, ID is 0 so EF knows it's new -->
                            <input type="hidden" name="Configurations[${variantIndex}].Id" value="0" />
                            <input type="hidden" name="Configurations[${variantIndex}].ProductId" value="@Model.Id" />

                            <div class="col-md-5">
                                <label class="form-label" style="font-size:13px;color:#64748b;">الوزن / الحجم (مثل: 1 كيلو)</label>
                                <input type="text" name="Configurations[${variantIndex}].Weight" class="admin-form-control" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label" style="font-size:13px;color:#64748b;">السعر (د.أ)</label>
                                <input type="number" step="0.01" name="Configurations[${variantIndex}].Price" class="admin-form-control" required />
                            </div>
                            <div class="col-md-2 text-center pb-2">
                                 <div class="form-check form-switch d-inline-block">
                                    <input class="form-check-input" type="checkbox" name="Configurations[${variantIndex}].IsDefault" value="true" id="default_${variantIndex}">
                                    <label class="form-check-label" style="font-size:12px;" for="default_${variantIndex}">افتراضي</label>
                                 </div>
                                 <input type="hidden" name="Configurations[${variantIndex}].IsDefault" value="false" />
                            </div>
                            <div class="col-md-1 text-end pb-1">
                                <button type="button" class="btn btn-sm btn-outline-danger remove-variant-btn" style="border:none;">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    $('#variantsContainer').append(html);
                    variantIndex++;
                });

                $(document).on('click', '.remove-variant-btn', function () {
                    $(this).closest('.variant-row').remove();

                    // Re-index variants
                    $('#variantsContainer .variant-row').each(function(index) {
                        $(this).find('input[name^="Configurations["]').each(function() {
                            const name = $(this).attr('name');
                            const newName = name.replace(/\[\d+\]/, `[${index}]`);
                            $(this).attr('name', newName); // ID, ProductId, Weight, Price, IsDefault
                        });
                    });
                    variantIndex = $('#variantsContainer .variant-row').length;
                });
            });
        </script>
}
